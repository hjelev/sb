#!/bin/bash
EXPORT_FILE=""; [[ "$1" == "--export-path" ]] && EXPORT_FILE="$2"
HIGHLIGHT='\033[1;44m'; BLUE='\033[1;34m'; GREEN='\033[1;32m'; CYAN='\033[1;36m'; RED='\033[1;31m'; NC='\033[0m'
cursor=1; old_cursor=0; old_scroll=-1; files=(); metadata=(); CLIPBOARD_PATH=""; CLIPBOARD_NAME=""; declare -A dir_positions
orig_stty=$(stty -g)
cleanup() { echo -ne "\033[?25h"; stty "$orig_stty"; [[ -n "$EXPORT_FILE" ]] && pwd > "$EXPORT_FILE"; clear; }
handle_resize() { get_terminal_size; old_cursor=-1; old_scroll=-1; stty -echo cbreak; printf "\033[2J\033[1;1H"; draw_ui; }
trap cleanup EXIT; trap handle_resize SIGWINCH; stty -echo cbreak
get_terminal_size() { term_rows=$(tput lines); term_cols=$(tput cols); max_rows=$((term_rows - 4)); }
get_color() { local f="$1"; [[ "$f" == */ ]] && echo -n "$BLUE" && return; [[ "$f" == *@ ]] && echo -n "$CYAN" && return; [[ "$f" == *\* ]] && echo -n "$GREEN" && return; [[ "$f" =~ \.(zip|tar|gz|rar|7z)$ ]] && echo -n "$RED" && return; echo -n "$NC"; }
update_files() { files=(); metadata=(); mapfile -t files < <(ls -F --group-directories-first 2>/dev/null); for f in "${files[@]}"; do clean_f=$(echo "$f" | sed 's/[$*@|=>]//g'); [[ -e "$clean_f" || -L "$clean_f" ]] && meta=$(ls -ldh "$clean_f" 2>/dev/null | awk '{printf "%s|%s|%s|%s %s %5s", $3, $1, $5, $6, $7, $8}') || meta="----------|----------|-----|------------"; metadata+=("$meta"); done; [[ ${#files[@]} -eq 0 ]] && files=("(Empty Directory)"); (( cursor > ${#files[@]} )) && cursor=${#files[@]}; }
draw_line() { local idx=$1; local row=$2; local f_name="${files[$idx]}"; local display_name="${f_name:0:20}"; local meta="${metadata[$idx]}"; IFS='|' read -r m_owner m_perms m_size m_mod <<< "$meta"; printf "\033[${row};1H"; if (( idx + 1 == cursor )); then printf "${HIGHLIGHT}%-20s${NC} %-12s %-11s %-8s %-14s" "$display_name" "$m_owner" "$m_perms" "$m_size" "$m_mod"; else printf "$(get_color "$f_name")%-20s${NC} %-12s %-11s %-8s %-14s" "$display_name" "$m_owner" "$m_perms" "$m_size" "$m_mod"; fi; }
draw_ui() { local total=${#files[@]}; local scroll=$(( cursor - 1 - max_rows / 2 )); [[ $scroll -lt 0 ]] && scroll=0; [[ $scroll -gt $((total - max_rows)) ]] && scroll=$(( total - max_rows )); [[ $scroll -lt 0 ]] && scroll=0; local buffer=""; buffer+=$'\e[2J\e[H\e[?25l'; buffer+=$(printf "%-20s %-12s %-11s %-8s %-14s\n" "FILE NAME" "OWNER" "PERMS" "SIZE" "MODIFIED"); buffer+=$'\e[2;1H'; for (( i=0; i<term_cols-1; i++ )); do buffer+="─"; done; buffer+=$'\n'; for (( i=0; i<max_rows && scroll+i<total; i++ )); do local idx=$((scroll + i)); local f_name="${files[$idx]}"; local display_name="${f_name:0:20}"; local meta="${metadata[$idx]}"; IFS='|' read -r m_owner m_perms m_size m_mod <<< "$meta"; buffer+=$'\e['$((i + 3))$';1H'; (( idx + 1 == cursor )) && buffer+="${HIGHLIGHT}$(printf "%-20s" "$display_name")${NC}" || buffer+="$(get_color "$f_name")$(printf "%-20s" "$display_name")${NC}"; buffer+=$(printf " %-12s %-11s %-8s %-14s\n" "$m_owner" "$m_perms" "$m_size" "$m_mod"); done; buffer+=$'\e['$((max_rows + 4))$';1H\e[K'; buffer+=$(printf "Item %d/%d │ Clip: %-8s │ Path: %s" "$cursor" "$total" "${CLIPBOARD_NAME:-None}" "$(pwd)"); printf "%b" "$buffer"; old_cursor=$cursor; old_scroll=$scroll; }
redraw_cursor() { local total=${#files[@]}; local scroll=$(( cursor - 1 - max_rows / 2 )); [[ $scroll -lt 0 ]] && scroll=0; [[ $scroll -gt $((total - max_rows)) ]] && scroll=$(( total - max_rows )); [[ $scroll -lt 0 ]] && scroll=0; if (( scroll != old_scroll )); then draw_ui; return; fi; local buffer=""; if (( old_cursor > 0 && old_cursor != cursor )); then local old_idx=$(( old_cursor - 1 )); if (( old_idx >= scroll && old_idx < scroll + max_rows )); then local f_name="${files[$old_idx]}"; local display_name="${f_name:0:20}"; local meta="${metadata[$old_idx]}"; IFS='|' read -r m_owner m_perms m_size m_mod <<< "$meta"; buffer+=$'\e['$((old_idx - scroll + 3))$';1H'; buffer+="$(get_color "$f_name")$(printf "%-20s" "$display_name")${NC}"; buffer+=$(printf " %-12s %-11s %-8s %-14s\n" "$m_owner" "$m_perms" "$m_size" "$m_mod"); fi; fi; local new_idx=$(( cursor - 1 )); if (( new_idx >= scroll && new_idx < scroll + max_rows )); then local f_name="${files[$new_idx]}"; local display_name="${f_name:0:20}"; local meta="${metadata[$new_idx]}"; IFS='|' read -r m_owner m_perms m_size m_mod <<< "$meta"; buffer+=$'\e['$((new_idx - scroll + 3))$';1H'; buffer+="${HIGHLIGHT}$(printf "%-20s" "$display_name")${NC}"; buffer+=$(printf " %-12s %-11s %-8s %-14s\n" "$m_owner" "$m_perms" "$m_size" "$m_mod"); fi; buffer+=$'\e['$((max_rows + 4))$';1H\e[K'; buffer+=$(printf "Item %d/%d │ Clip: %-8s │ Path: %s" "$cursor" "${#files[@]}" "${CLIPBOARD_NAME:-None}" "$(pwd)"); printf "%b" "$buffer"; old_cursor=$cursor; old_scroll=$scroll; }
get_item() { [[ $cursor -gt 0 && $cursor -le ${#files[@]} ]] && echo "${files[$((cursor-1))]}" | sed 's/[$*@|=>]//g'; }
open_file() { local item="$1"; if command -v chafa &>/dev/null && [[ "$item" =~ \.(jpg|jpeg|png|gif|bmp|webp|tiff|ico)$ ]]; then echo -ne "\033[?25h"; tput smcup; printf "\033[H"; chafa "$item" | head -n $((term_rows - 2)); printf "\033[$((term_rows));1H"; read -rsn1; tput rmcup; echo -ne "\033[?25l"; redraw_cursor; else xdg-open "$item" 2>/dev/null; fi; }
echo -ne "\033[?25l"; get_terminal_size; update_files; draw_ui
while true; do read -rsn1 key; if [[ $key == $'\e' ]]; then while read -rsn1 -t 0.001 key_rest; do key+="$key_rest"; done; fi; case "$key" in
$'\e[A') ((cursor > 1)) && ((cursor--)) && redraw_cursor ;;
$'\e[B') ((cursor < ${#files[@]})) && ((cursor++)) && redraw_cursor ;;
$'\e[5~') old_cursor=$cursor; ((cursor -= max_rows)); (( cursor < 1 )) && cursor=1; (( cursor != old_cursor )) && redraw_cursor ;;
$'\e[6~') old_cursor=$cursor; ((cursor += max_rows)); (( cursor > ${#files[@]} )) && cursor=${#files[@]}; (( cursor != old_cursor )) && redraw_cursor ;;
$'\e[H'|$'\e[1~'|$'\e[7~'|$'\eOH') ((cursor > 1)) && cursor=1 && redraw_cursor ;;
$'\e[F'|$'\e[4~'|$'\e[8~'|$'\eOF') ((cursor < ${#files[@]})) && cursor=${#files[@]} && redraw_cursor ;;
$'\e[C'|$'\n') item=$(get_item); if [ -d "$item" ]; then dir_positions["$(pwd)"]=$cursor; cd "$item" 2>/dev/null; get_terminal_size; update_files; cursor=${dir_positions["$(pwd)"]:-1}; (( cursor > ${#files[@]} )) && cursor=${#files[@]}; draw_ui; elif [ -f "$item" ]; then open_file "$item"; fi ;;
$'\e[D') dir_positions["$(pwd)"]=$cursor; cd .. 2>/dev/null; get_terminal_size; update_files; cursor=${dir_positions["$(pwd)"]:-1}; (( cursor > ${#files[@]} )) && cursor=${#files[@]}; draw_ui ;;
'~') dir_positions["$(pwd)"]=$cursor; cd "$HOME" 2>/dev/null; get_terminal_size; update_files; cursor=${dir_positions["$(pwd)"]:-1}; (( cursor > ${#files[@]} )) && cursor=${#files[@]}; draw_ui ;;
'c') item=$(get_item); [[ "$item" != "(Empty Directory)" ]] && CLIPBOARD_PATH="$(pwd)/$item" && CLIPBOARD_NAME="$item" && redraw_cursor ;;
'p') [[ -n "$CLIPBOARD_PATH" ]] && { dest="$CLIPBOARD_NAME"; [[ -e "$dest" ]] && { echo -ne "\033[?25h"; printf "\033[$((max_rows + 4));1H\033[K"; stty echo; read -e -i "$dest" -p "New name: " dest; stty -echo cbreak; echo -ne "\033[?25l"; }; cp -r "$CLIPBOARD_PATH" "$dest" 2>/dev/null && { update_files; draw_ui; } } ;;
'h') echo -ne "\033[?25h"; clear; echo "↑/↓: Navigate | PgUp/PgDn: Page | Home/End: Top/Bottom | →/Enter: Open | ←: Back | ~: Home | c: Copy | p: Paste | q: Quit"; read -rsn1; draw_ui ;;
'q') break ;;
esac; done
